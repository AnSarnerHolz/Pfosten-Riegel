<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cutting Plan — Custom Stock Length</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    // Utility: download a CSV file
    function downloadCSV(filename, rows) {
      const process = (r) => r.map(v => {
        if (v == null) return '';
        const s = String(v);
        if (s.includes(',') || s.includes('\n') || s.includes('"')) {
          return '"' + s.replace(/"/g, '""') + '"';
        }
        return s;
      }).join(',');
      const csv = rows.map(process).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Parse CSV text into demand array
    function parseCSV(text) {
      const lines = text.trim().split(/\r?\n/);
      const demand = [];
      for (let i = 0; i < lines.length; i++) {
        const [lenStr, qtyStr] = lines[i].split(',');
        const len = parseInt(lenStr.trim(), 10);
        const qty = parseInt(qtyStr.trim(), 10);
        if (isFinite(len) && isFinite(qty) && len > 0 && qty > 0) {
          demand.push({ lengthMM: len, qty });
        }
      }
      return demand;
    }

    // Core solver: repeated bounded knapsack using binary-split expansion
    function planCuts(demand, stockLengthMM) {
      const items = demand
        .filter(r => r.lengthMM > 0 && r.qty > 0)
        .map(r => ({ L: r.lengthMM, qty: Math.max(0, Math.floor(r.qty)) }))
        .sort((a, b) => b.L - a.L);

      if (items.length === 0) return { bars: [], summary: { totalBars: 0, totalWasteMM: 0 } };

      const remaining = new Map(items.map(it => [it.L, it.qty]));
      const bars = [];

      function anyRemaining() {
        for (const [, q] of remaining) if (q > 0) return true;
        return false;
      }

      function boundedKnapsack() {
        const weights = [];
        const payload = [];

        for (const { L, qty } of items) {
          let q = remaining.get(L) || 0;
          let k = 1;
          while (q > 0) {
            const take = Math.min(k, q);
            weights.push(L * take);
            payload.push({ Ltrue: L, cnt: take });
            q -= take;
            k *= 2;
          }
        }
        if (!weights.length) return null;

        const cap = stockLengthMM;
        const dp = new Int32Array(cap + 1).fill(-1);
        dp[0] = 0;
        const choice = new Int32Array(cap + 1).fill(-1);

        for (let idx = 0; idx < weights.length; idx++) {
          const w = weights[idx];
          for (let c = cap; c >= w; c--) {
            if (dp[c - w] !== -1) {
              const cand = dp[c - w] + w;
              if (cand > dp[c]) {
                dp[c] = cand;
                choice[c] = idx;
              }
            }
          }
        }

        let bestC = 0;
        for (let c = 1; c <= cap; c++) if (dp[c] > dp[bestC]) bestC = c;
        if (dp[bestC] <= 0) return null;

        const cutCounts = new Map();
        let c = bestC;
        while (c > 0 && choice[c] !== -1) {
          const idx = choice[c];
          const w = weights[idx];
          const { Ltrue, cnt } = payload[idx];
          cutCounts.set(Ltrue, (cutCounts.get(Ltrue) || 0) + cnt);
          c -= w;
        }
        if (cutCounts.size === 0) return null;
        return cutCounts;
      }

      while (anyRemaining()) {
        let picks = boundedKnapsack();
        if (!picks) {
          let longest = -1;
          for (const [L, q] of remaining) if (q > 0) longest = Math.max(longest, L);
          if (longest === -1) break;
          picks = new Map([[longest, 1]]);
        }

        let used = 0;
        let pieces = [];
        for (const [L, cnt] of picks) {
          used += L * cnt;
          pieces.push({ L, cnt });
        }
        if (used > stockLengthMM) {
          pieces.sort((a, b) => a.L - b.L);
          while (used > stockLengthMM && pieces.length) {
            const p = pieces[0];
            p.cnt -= 1;
            used -= p.L;
            if (p.cnt <= 0) pieces.shift();
          }
          picks = new Map();
          for (const p of pieces) picks.set(p.L, p.cnt);
        }

        const waste = stockLengthMM - used;
        bars.push({ picks: new Map(picks), waste });
        for (const [L, cnt] of picks) {
          remaining.set(L, Math.max(0, (remaining.get(L) || 0) - cnt));
        }
      }

      const summary = {
        totalBars: bars.length,
        totalWasteMM: bars.reduce((acc, b) => acc + b.waste, 0)
      };
      return { bars, summary };
    }

    function humanCuts(picks) {
      const arr = Array.from(picks.entries())
        .sort((a, b) => b[0] - a[0])
        .map(([L, cnt]) => `${cnt}×${L}mm`);
      return arr.join(' + ');
    }

    function runSolver() {
      const tbody = document.querySelector('#demandBody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const demand = [];
      for (const tr of rows) {
        const len = parseInt(tr.querySelector('.len').value, 10);
        const qty = parseInt(tr.querySelector('.qty').value, 10);
        if (!isFinite(len) || !isFinite(qty)) continue;
        if (len > 0 && qty > 0) demand.push({ lengthMM: len, qty });
      }
      const stockLengthMM = parseInt(document.querySelector('#stockLength').value, 10);
      const { bars, summary } = planCuts(demand, stockLengthMM);

      const out = document.querySelector('#resultsBody');
      out.innerHTML = '';
      bars.forEach((bar, i) => {
        const tr = document.createElement('tr');
        const usedMM = ( (stockLengthMM - bar.waste) );
        const wasteMM = bar.waste;
        tr.innerHTML = `
          <td class="cell">${i + 1}</td>
          <td class="cell">${humanCuts(bar.picks)}</td>
          <td class="cell right">${usedMM} mm</td>
          <td class="cell right">${wasteMM} mm</td>
        `;
        out.appendChild(tr);
      });

      document.querySelector('#summaryBars').textContent = summary.totalBars;
      document.querySelector('#summaryWaste').textContent = summary.totalWasteMM + " mm";

      document.querySelector('#btnCSV').onclick = () => {
        const rows = [["Bar #","Cuts","Used (mm)","Waste (mm)"]];
        bars.forEach((bar, i) => {
          const usedMM = (stockLengthMM - bar.waste);
          const wasteMM = bar.waste;
          rows.push([i+1, humanCuts(bar.picks), usedMM, wasteMM]);
        });
        downloadCSV('cutting_plan.csv', rows);
      };
    }

    function addRow(len = '', qty = '') {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="cell"><input class="len" type="number" step="1" min="0" value="${len}"></td>
        <td class="cell"><input class="qty" type="number" step="1" min="0" value="${qty}"></td>
        <td class="cell"><button class="ghost" onclick="this.closest('tr').remove();">✕</button></td>
      `;
      document.querySelector('#demandBody').appendChild(tr);
    }

    function loadCSVFile(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const text = e.target.result;
        const demand = parseCSV(text);
        const tbody = document.querySelector('#demandBody');
        tbody.innerHTML = '';
        demand.forEach(r => addRow(r.lengthMM, r.qty));
      };
      reader.readAsText(file);
    }

    window.addEventListener('DOMContentLoaded', () => {
      document.querySelector('#btnAdd').addEventListener('click', () => addRow());
      document.querySelector('#btnSolve').addEventListener('click', runSolver);
      document.querySelector('#btnCSV').addEventListener('click', () => {});
      document.querySelector('#btnClear').addEventListener('click', () => {
        document.querySelector('#resultsBody').innerHTML = '';
        document.querySelector('#summaryBars').textContent = '0';
        document.querySelector('#summaryWaste').textContent = '0 mm';
      });
      document.querySelector('#fileInput').addEventListener('change', loadCSVFile);
    });
  </script>
  <style>
    :root { --bg: #0b0f19; --panel: #121829; --ink: #e5e7eb; --muted: #9aa4b2; }
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: var(--ink); }
    .container { max-width: 1100px; margin: 40px auto; padding: 0 16px; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border: 1px solid rgba(255,255,255,0.08); border-radius: 18px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    h1 { font-size: 24px; margin: 0; }
    p.sub { color: var(--muted); margin: 6px 0 0; font-size: 14px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

    .panel { padding: 16px; }
    .panel h2 { font-size: 16px; margin: 0 0 8px; font-weight: 600; }

    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 12px; border-bottom: 1px dashed rgba(255,255,255,0.08); }
    th { text-align: left; color: var(--muted); font-weight: 500; font-size: 13px; }
    td.cell { font-size: 14px; }
    td.cell.right { text-align: right; }

    input[type="number"] { width: 100%; padding: 8px 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.14); background: #0f1523; color: var(--ink); }
    input[type="file"] { color: var(--ink); }

    .toolbar { display: flex; gap: 8px; margin: 8px 0 12px; flex-wrap: wrap; }
    button { padding: 10px 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12); background: #1a2440; color: var(--ink); cursor: pointer; font-weight: 600; }
    button:hover { border-color: rgba(255,255,255,0.25); }
    button.ghost { background: transparent; border: 1px solid rgba(255,255,255,0.14); padding: 6px 10px; }

    .summary { display: flex; gap: 24px; align-items: baseline; margin-top: 8px; color: var(--muted); }
    .summary strong { color: var(--ink); font-size: 18px; margin-left: 6px; }
    footer.note { color: var(--muted); font-size: 12px; margin-top: 16px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Cutting Plan</h1>
        <p class="sub">Heuristic solver with customizable stock length. Units: millimeters only.</p>
      </div>
      <div class="summary">
        <span>Total Bars:<strong id="summaryBars">0</strong></span>
        <span>Total Waste:<strong id="summaryWaste">0 mm</strong></span>
      </div>
    </header>

    <div class="grid">
      <section class="card panel">
        <h2>Demand</h2>
        <div class="toolbar">
          <button id="btnAdd">+ Add row</button>
          <button id="btnSolve">Solve</button>
          <button id="btnCSV">Download CSV</button>
          <button id="btnClear">Clear Results</button>
          <input type="file" id="fileInput" accept=".csv,.txt,.xls,.xlsx" />
        </div>
        <div class="toolbar">
          <label for="stockLength">Stock length (mm): </label>
          <input type="number" id="stockLength" value="6000" min="100" step="10" />
        </div>
        <table>
          <thead>
            <tr>
              <th>Length (mm)</th>
              <th>Quantity</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="demandBody"></tbody>
        </table>
        <footer class="note">Tip: Input length in millimeters. You can also upload a CSV file with columns: length,quantity.</footer>
      </section>

      <section class="card panel">
        <h2>Cut Plan</h2>
        <table>
          <thead>
            <tr>
              <th>Bar #</th>
              <th>Cuts</th>
              <th class="right">Used</th>
              <th class="right">Waste</th>
            </tr>
          </thead>
          <tbody id="resultsBody"></tbody>
        </table>
      </section>
    </div>
  </div>
</body>
</html>
